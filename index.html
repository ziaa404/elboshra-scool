<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ - Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¨Ø´Ø±Ù‰ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©">
    <meta name="author" content="Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¨Ø´Ø±Ù‰ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©">
    <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¨Ø´Ø±Ù‰ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.1/purify.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" defer></script>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg-light: rgba(255,255,255,0.95);
            --bg-dark: #1f2937;
            --text-dark: #1f2937;
            --text-light: #f3f4f6;
        }

        [data-theme="dark"] {
            --bg-light: #1f2937;
            --text-dark: #f3f4f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Naskh Arabic', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            transition: background 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--bg-light);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .header h1 {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        .login-section {
            background: var(--bg-light);
            padding: 60px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .google-btn {
            background: linear-gradient(45deg, #4285f4, #1a73e8);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(66, 133, 244, 0.3);
        }
        
        .google-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(66, 133, 244, 0.4);
        }
        
        .google-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .dashboard {
            display: none;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }
        
        .sidebar, .main-content {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            margin: 8px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(79, 70, 229, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #b91c1c);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success), #047857);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #f59e0b);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.9rem;
            margin: 3px;
        }
        
        .student-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 25px;
            margin: 15px 0;
            border-radius: 20px;
            border-left: 6px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: all 0.4s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease forwards;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .student-card:hover {
            transform: translateX(-8px) translateY(-3px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }

        .student-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
            background: #e5e7eb;
        }
        
        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            margin: 12px 0;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .skill-item:hover {
            transform: translateX(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .skill-management {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 4px solid var(--warning);
        }

        .skill-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .skill-list-item, .delegated-teacher-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .delegated-teacher-item span {
            font-weight: 600;
        }

        .delegated-teacher-item .permission {
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .mastered { color: var(--success); }
        .not-mastered { color: var(--danger); }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #047857);
            transition: width 0.6s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        input[type="text"], input[type="search"], input[type="file"], select {
            width: 100%;
            padding: 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: var(--bg-light);
            margin: 10px 0;
        }
        
        input[type="text"]:focus, input[type="search"]:focus, input[type="file"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 25px 0;
            padding: 20px;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 20px;
        }
        
        .welcome-message {
            text-align: center;
            padding: 80px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 25px;
            border: 2px dashed #cbd5e1;
        }
        
        .welcome-message h2 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .welcome-message p {
            color: #6b7280;
            font-size: 1.3rem;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-light);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-dark);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-light);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .error-message {
            background: #fee2e2;
            color: var(--danger);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .search-container {
            margin-bottom: 20px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--bg-light);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-details-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .student-details-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            background: #e5e7eb;
        }

        .no-subjects-message {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 15px;
            border: 2px dashed #f59e0b;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
            .container { padding: 15px; }
            .tab-buttons { flex-direction: column; }
            .theme-toggle { top: 10px; left: 10px; }
            .student-image { width: 40px; height: 40px; }
            .student-details-image { width: 80px; height: 80px; }
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
    <div class="container">
        <div class="header">
            <h1>ğŸ« Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¨Ø´Ø±Ù‰ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</h1>
            <p>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</p>
        </div>

        <div id="loginSection" class="login-section">
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h2>
            <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
            <input type="text" id="loginUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <button class="google-btn" onclick="mockGoogleLogin()" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="sidebar">
                <div style="margin-bottom: 30px;">
                    <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©:</h3>
                    <input type="text" id="teacherName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" onchange="save()" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
                    <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px; width: 100%;" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                        ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
                
                <div class="search-container">
                    <input type="search" id="studentSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="searchStudents()" aria-label="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨">
                </div>
                
                <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <input type="text" id="newStudent" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯" aria-label="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <input type="file" id="newStudentImage" accept="image/*" aria-label="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <button class="btn" onclick="addStudent()" aria-label="Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="exportData()" aria-label="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="btn btn-warning" onclick="importData()" aria-label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="btn btn-danger" onclick="resetData()" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                </div>
                
                <div id="studentsList"></div>
            </div>

            <div class="main-content">
                <div id="errorMessage" class="error-message" role="alert"></div>
                <div id="studentDetails" style="display: none;">
                    <div class="student-details-header">
                        <img id="currentStudentImage" class="student-details-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">
                        <div>
                            <h2 id="currentStudentName"></h2>
                            <input type="file" id="updateStudentImage" accept="image/*" aria-label="ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">
                            <button class="btn btn-small" onclick="updateStudentImage()" aria-label="ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©</button>
                        </div>
                    </div>
                    
                    <div class="tab-buttons" id="subjectTabs"></div>
                    <div id="content"></div>
                </div>
                
                <div id="welcome" class="welcome-message">
                    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h2>
                    <p>Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <div id="skillModal" class="modal" role="dialog">
        <div class="modal-content">
            <span class="close" onclick="closeModal('skillModal')" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">Ã—</span>
            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <select id="skillSubject" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©"></select>
            <input type="text" id="newSkillName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <button class="btn" onclick="addNewSkill()" aria-label="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©" id="addSkillButton">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©</button>
        </div>
    </div>

    <div id="subjectModal" class="modal" role="dialog">
        <div class="modal-content">
            <span class="close" onclick="closeModal('subjectModal')" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">Ã—</span>
            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <input type="text" id="newSubjectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <button class="btn" onclick="addNewSubject()" aria-label="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©</button>
        </div>
    </div>

    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleFileImport(event)">

    <script>
        const defaultSkills = {
            reading: ['Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙˆÙ', 'Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙØªØ­', 'Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙƒØ³Ø±', 'Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø­Ø±ÙƒØ© Ø§Ù„Ø¶Ù…', 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ø­Ø±ÙˆÙ', 'Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„Ù…Ø§Øª Ø«Ù„Ø§Ø«ÙŠØ©', 'Ø§Ù„Ù…Ø¯ Ø¨Ø§Ù„Ø£Ù„Ù ÙˆØ§Ù„ÙˆØ§Ùˆ ÙˆØ§Ù„ÙŠØ§Ø¡', 'Ø§Ù„Ø³ÙƒÙˆÙ†', 'Ø§Ù„Ù„Ø§Ù… Ø§Ù„Ù‚Ù…Ø±ÙŠØ©', 'Ø§Ù„Ø´Ø¯Ø©', 'Ø§Ù„Ù„Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØ©', 'Ø§Ù„ØªÙ†ÙˆÙŠÙ†'],
            writing: ['Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙˆÙ', 'Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙØªØ­', 'Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙƒØ³Ø± ÙˆØ§Ù„Ø¶Ù…', 'Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ø­Ø±ÙˆÙ', 'ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø§Øª Ø«Ù„Ø§Ø«ÙŠØ©', 'Ø§Ù„Ù…Ø¯ Ø¨Ø§Ù„Ø£Ù„Ù ÙˆØ§Ù„ÙˆØ§Ùˆ ÙˆØ§Ù„ÙŠØ§Ø¡', 'Ø§Ù„Ø³ÙƒÙˆÙ†', 'Ø§Ù„Ù„Ø§Ù… Ø§Ù„Ù‚Ù…Ø±ÙŠØ©', 'Ø§Ù„Ø´Ø¯Ø©', 'Ø§Ù„Ù„Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØ©', 'Ø§Ù„ØªÙ†ÙˆÙŠÙ†', 'Ø§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©']
        };

        const defaultSubjectNames = { reading: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', writing: 'Ø§Ù„ÙƒØªØ§Ø¨Ø©' };

        const defaultImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

        let skills = {...defaultSkills};
        let subjectNames = {...defaultSubjectNames};
        let delegatedTeachers = {};
        let current = null, data = {}, currentUser = null;
        let chartInstance = null;
        const ENCRYPTION_KEY = 'schools-albushra-2025';

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function sanitizeInput(input) {
            return DOMPurify.sanitize(input.trim(), { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
        }

        function encryptData(data) {
            if (!window.CryptoJS) {
                throw new Error('Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ´ÙÙŠØ± ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            }
            return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
        }

        function decryptData(encrypted) {
            if (!window.CryptoJS) {
                throw new Error('Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ´ÙÙŠØ± ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            }
            try {
                const bytes = CryptoJS.AES.decrypt(encrypted, ENCRYPTION_KEY);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                if (!decrypted) {
                    throw new Error('ÙØ´Ù„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±: Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                }
                return JSON.parse(decrypted);
            } catch (error) {
                throw new Error('ÙØ´Ù„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±: ' + error.message);
            }
        }

        async function load() {
            showLoading(true);
            try {
                console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                const savedData = localStorage.getItem('studentsData');
                const savedTeacher = localStorage.getItem('teacherName');
                const savedUser = localStorage.getItem('currentUser');
                const savedSkills = localStorage.getItem('customSkills');
                const savedSubjectNames = localStorage.getItem('subjectNames');
                const savedDelegatedTeachers = localStorage.getItem('delegatedTeachers');

                if (savedData) {
                    try {
                        data = decryptData(savedData);
                    } catch (decryptError) {
                        try {
                            data = JSON.parse(savedData);
                            localStorage.setItem('studentsData', encryptData(data));
                        } catch (jsonError) {
                            console.error('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', jsonError);
                            showError('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†');
                            data = {};
                            localStorage.removeItem('studentsData');
                        }
                    }
                    if (!isValidData(data)) {
                        console.error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                        data = {};
                        localStorage.removeItem('studentsData');
                    }
                }

                if (savedSkills) {
                    try {
                        skills = decryptData(savedSkills);
                    } catch (decryptError) {
                        try {
                            skills = JSON.parse(savedSkills);
                            localStorage.setItem('customSkills', encryptData(skills));
                        } catch (jsonError) {
                            console.error('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª:', jsonError);
                            skills = {...defaultSkills};
                            localStorage.removeItem('customSkills');
                        }
                    }
                    if (!isValidSkills(skills)) {
                        console.error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                        skills = {...defaultSkills};
                        localStorage.removeItem('customSkills');
                    }
                } else {
                    skills = {...defaultSkills};
                }

                if (savedSubjectNames) {
                    try {
                        subjectNames = decryptData(savedSubjectNames);
                    } catch (decryptError) {
                        try {
                            subjectNames = JSON.parse(savedSubjectNames);
                            localStorage.setItem('subjectNames', encryptData(subjectNames));
                        } catch (jsonError) {
                            console.error('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯:', jsonError);
                            subjectNames = {...defaultSubjectNames};
                            localStorage.removeItem('subjectNames');
                        }
                    }
                    if (!isValidSubjectNames(subjectNames)) {
                        console.error('Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                        subjectNames = {...defaultSubjectNames};
                        localStorage.removeItem('subjectNames');
                    }
                } else {
                    subjectNames = {...defaultSubjectNames};
                }

                if (savedDelegatedTeachers) {
                    try {
                        delegatedTeachers = decryptData(savedDelegatedTeachers);
                    } catch (decryptError) {
                        try {
                            delegatedTeachers = JSON.parse(savedDelegatedTeachers);
                            localStorage.setItem('delegatedTeachers', encryptData(delegatedTeachers));
                        } catch (jsonError) {
                            console.error('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶:', jsonError);
                            delegatedTeachers = {};
                            localStorage.removeItem('delegatedTeachers');
                        }
                    }
                    if (!isValidDelegatedTeachers(delegatedTeachers)) {
                        console.error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶ ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                        delegatedTeachers = {};
                        localStorage.removeItem('delegatedTeachers');
                    }
                }

                if (savedTeacher) {
                    document.getElementById('teacherName').value = sanitizeInput(savedTeacher);
                }

                if (savedUser) {
                    try {
                        currentUser = decryptData(savedUser);
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'grid';
                    } catch (error) {
                        console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:', error);
                        localStorage.removeItem('currentUser');
                        currentUser = null;
                    }
                }

                updateList();
                updateSubjectTabs();
                restrictUIByPermission();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}. Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.`);
                data = {};
                skills = {...defaultSkills};
                subjectNames = {...defaultSubjectNames};
                delegatedTeachers = {};
            } finally {
                showLoading(false);
            }
        }

        function isValidData(data) {
            if (!data || typeof data !== 'object') return false;
            return Object.values(data).every(student => 
                student.name && 
                (student.image === null || typeof student.image === 'string') &&
                Object.keys(skills).every(subject => 
                    typeof student[subject] === 'object' || student[subject] === undefined
                )
            );
        }

        function isValidSkills(skills) {
            if (!skills || typeof skills !== 'object') return false;
            return Object.keys(skills).every(subject => 
                Array.isArray(skills[subject]) && 
                skills[subject].every(skill => typeof skill === 'string')
            );
        }

        function isValidSubjectNames(names) {
            if (!names || typeof names !== 'object') return false;
            return Object.entries(names).every(([key, name]) => 
                typeof key === 'string' && 
                typeof name === 'string' && 
                /^[\u0600-\u06FF\s]{2,50}$/.test(name)
            );
        }

        function isValidDelegatedTeachers(teachers) {
            if (!teachers || typeof teachers !== 'object') return false;
            return Object.entries(teachers).every(([id, teacher]) =>
                typeof id === 'string' &&
                teacher.name && typeof teacher.name === 'string' &&
                ['read', 'edit', 'admin'].includes(teacher.permission)
            );
        }

        function save() {
            try {
                localStorage.setItem('studentsData', encryptData(data));
                localStorage.setItem('teacherName', sanitizeInput(document.getElementById('teacherName').value));
                localStorage.setItem('customSkills', encryptData(skills));
                localStorage.setItem('subjectNames', encryptData(subjectNames));
                localStorage.setItem('delegatedTeachers', encryptData(delegatedTeachers));
                localStorage.setItem('lastSaved', new Date().toISOString());
                showSaveMessage();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }

        function showSaveMessage() {
            const msg = document.createElement('div');
            msg.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, var(--success), #047857);
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                z-index: 9999;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(msg), 300);
            }, 2000);
        }

        async function mockGoogleLogin() {
            showLoading(true);
            try {
                if (!window.CryptoJS) {
                    throw new Error('Ù…ÙƒØªØ¨Ø© CryptoJS ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„Ù‡Ø§.');
                }
                const userName = sanitizeInput(document.getElementById('loginUserName').value);
                if (!userName) {
                    showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…');
                    return;
                }
                const userId = CryptoJS.SHA256(userName + Date.now()).toString();
                currentUser = {
                    loginTime: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    userId: userId,
                    name: userName,
                    permission: delegatedTeachers[userId]?.permission || 'admin'
                };
                console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', currentUser);
                localStorage.setItem('currentUser', encryptData(currentUser));
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';
                document.getElementById('loginUserName').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                await load();
                restrictUIByPermission();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.')) {
                save();
                localStorage.removeItem('currentUser');
                currentUser = null;
                location.reload();
            }
        }

        function resetData() {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªÙÙˆÙŠØ¶Ø§Øª.')) {
                data = {};
                skills = {};
                subjectNames = {};
                delegatedTeachers = {};
                current = null;
                localStorage.removeItem('studentsData');
                localStorage.removeItem('customSkills');
                localStorage.removeItem('subjectNames');
                localStorage.removeItem('delegatedTeachers');
                document.getElementById('studentDetails').style.display = 'none';
                document.getElementById('welcome').style.display = 'block';
                document.getElementById('teacherName').value = '';
                updateList();
                updateSubjectTabs();
                showSaveMessage();
            }
        }

        function validateStudentName(name) {
            const regex = /^[\u0600-\u06FF\s]{2,50}$/;
            return regex.test(name);
        }

        function validateTeacherName(name) {
            const regex = /^[\u0600-\u06FF\s]{2,50}$/;
            return regex.test(name);
        }

        function validateImage(file) {
            const maxSize = 1 * 1024 * 1024; // 1MB
            const allowedTypes = ['image/jpeg', 'image/png'];
            if (!file) return true; // Image is optional
            if (!allowedTypes.includes(file.type)) {
                showError('ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© JPEG Ø£Ùˆ PNG');
                return false;
            }
            if (file.size > maxSize) {
                showError('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 1 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                return false;
            }
            return true;
        }

        function readImage(file) {
            return new Promise((resolve, reject) => {
                if (!file) resolve(null);
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
                reader.readAsDataURL(file);
            });
        }

        async function addStudent() {
            if (currentUser?.permission === 'read') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨');
                return;
            }
            const name = sanitizeInput(document.getElementById('newStudent').value);
            const imageInput = document.getElementById('newStudentImage');
            const file = imageInput.files[0];

            if (!validateStudentName(name)) {
                showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø·Ø§Ù„Ø¨ ØµØ§Ù„Ø­ (2-50 Ø­Ø±ÙÙ‹Ø§ Ø¹Ø±Ø¨ÙŠÙ‹Ø§)');
                return;
            }

            if (!validateImage(file)) {
                return;
            }

            showLoading(true);
            try {
                const image = await readImage(file);
                const id = CryptoJS.SHA256(name + Date.now()).toString();
                data[id] = { name, image: image || null };
                
                Object.keys(skills).forEach(subject => {
                    data[id][subject] = {};
                    skills[subject].forEach(skill => {
                        data[id][subject][skill] = 'not_assessed';
                    });
                });
                
                document.getElementById('newStudent').value = '';
                imageInput.value = '';
                save();
                updateList();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function updateStudentImage() {
            if (currentUser?.permission === 'read') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©');
                return;
            }
            if (!current) return;
            const imageInput = document.getElementById('updateStudentImage');
            const file = imageInput.files[0];

            if (!validateImage(file)) {
                return;
            }

            showLoading(true);
            try {
                const image = await readImage(file);
                data[current].image = image || null;
                document.getElementById('currentStudentImage').src = image || defaultImage;
                imageInput.value = '';
                save();
                updateList();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            updateList(searchTerm);
        }

        function updateList(searchTerm = '') {
            const list = document.getElementById('studentsList');
            list.innerHTML = '';
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            
            Object.entries(data)
                .filter(([_, student]) => student.name.toLowerCase().includes(searchTerm))
                .forEach(([id, student]) => {
                    const progress = calcProgress(id);
                    const card = document.createElement('div');
                    card.className = 'student-card';
                    card.setAttribute('role', 'listitem');
                    card.innerHTML = `
                        <img src="${student.image || defaultImage}" class="student-image" alt="ØµÙˆØ±Ø© ${sanitizeInput(student.name)}">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4>${sanitizeInput(student.name)}</h4>
                                <div>
                                    <button class="btn btn-small" onclick="select('${id}')" aria-label="Ø§Ø®ØªÙŠØ§Ø± ${student.name}">Ø§Ø®ØªÙŠØ§Ø±</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteStudent('${id}')" aria-label="Ø­Ø°Ù ${student.name}" style="${currentUser?.permission !== 'admin' ? 'display: none;' : ''}">Ø­Ø°Ù</button>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <small>Ø§Ù„ØªÙ‚Ø¯Ù…: ${progress.toFixed(1)}%</small>
                        </div>
                    `;
                    list.appendChild(card);
                    observer.observe(card);
                });
        }

        function calcProgress(id) {
            const student = data[id];
            let total = 0, mastered = 0;
            Object.keys(skills).forEach(subject => {
                if (student[subject]) {
                    Object.values(student[subject]).forEach(status => {
                        total++;
                        if (status === 'mastered') mastered++;
                    });
                }
            });
            return total > 0 ? (mastered / total) * 100 : 0;
        }

        function select(id) {
            current = id;
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('studentDetails').style.display = 'block';
            document.getElementById('currentStudentName').textContent = sanitizeInput(data[id].name);
            document.getElementById('currentStudentImage').src = data[id].image || defaultImage;
            
            syncStudentSkills(id);
            updateSubjectTabs();
            if (Object.keys(skills).length > 0) {
                showSubject(Object.keys(skills)[0]);
            } else {
                showSkillManagement();
            }
        }

        function syncStudentSkills(id) {
            Object.keys(skills).forEach(subject => {
                if (!data[id][subject]) {
                    data[id][subject] = {};
                }
                skills[subject].forEach(skill => {
                    if (!(skill in data[id][subject])) {
                        data[id][subject][skill] = 'not_assessed';
                    }
                });
            });
            Object.keys(data[id]).forEach(key => {
                if (key !== 'name' && key !== 'image' && !skills[key]) {
                    delete data[id][key];
                }
            });
            save();
        }

        function deleteStudent(id) {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø§Ø¨');
                return;
            }
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                delete data[id];
                if (current === id) {
                    current = null;
                    document.getElementById('studentDetails').style.display = 'none';
                    document.getElementById('welcome').style.display = 'block';
                }
                save();
                updateList();
            }
        }

        function updateSubjectTabs() {
            const tabContainer = document.getElementById('subjectTabs');
            tabContainer.innerHTML = '';
            if (Object.keys(skills).length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="no-subjects-message">
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø©</h3>
                        <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</p>
                    </div>
                `;
            } else {
                Object.keys(skills).forEach(subject => {
                    const displayName = sanitizeInput(subjectNames[subject] || subject);
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `ğŸ“š ${displayName}`;
                    button.setAttribute('aria-label', `Ø¹Ø±Ø¶ Ù…Ù‡Ø§Ø±Ø§Øª ${displayName}`);
                    button.onclick = () => showSubject(subject);
                    tabContainer.appendChild(button);
                });
            }
            const managementButton = document.createElement('button');
            managementButton.className = 'btn btn-warning';
            managementButton.innerHTML = 'âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª';
            managementButton.setAttribute('aria-label', 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª');
            managementButton.onclick = showSkillManagement;
            tabContainer.appendChild(managementButton);
            const chartButton = document.createElement('button');
            chartButton.className = 'btn';
            chartButton.innerHTML = 'ğŸ“Š Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ';
            chartButton.setAttribute('aria-label', 'Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ');
            chartButton.onclick = showChart;
            tabContainer.appendChild(chartButton);
            const reportButton = document.createElement('button');
            reportButton.className = 'btn btn-success';
            reportButton.innerHTML = 'ğŸ“„ ØªÙ‚Ø±ÙŠØ±';
            reportButton.setAttribute('aria-label', 'Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±');
            reportButton.onclick = generateReport;
            tabContainer.appendChild(reportButton);
            restrictUIByPermission();
        }

        function showSubject(subject) {
            if (!current || !skills[subject]) {
                console.error('Ø®Ø·Ø£: Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨', { subject, current });
                return;
            }
            
            const displayName = sanitizeInput(subjectNames[subject] || subject);
            let html = `<h3>${displayName}</h3>`;
            
            skills[subject].forEach(skill => {
                const status = data[current][subject][skill] || 'not_assessed';
                const disabled = currentUser?.permission === 'read' ? 'disabled' : '';
                html += `
                    <div class="skill-item" role="listitem">
                        <span>${sanitizeInput(skill)}</span>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="${subject}_${skill}" value="mastered" 
                                    ${status === 'mastered' ? 'checked' : ''} 
                                    onchange="updateSkill('${subject}', '${skill}', 'mastered')"
                                    aria-label="Ø£ØªÙ‚Ù† ${skill}" ${disabled}>
                                <span class="mastered">Ø£ØªÙ‚Ù†</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="${subject}_${skill}" value="not_mastered"
                                    ${status === 'not_mastered' ? 'checked' : ''} 
                                    onchange="updateSkill('${subject}', '${skill}', 'not_mastered')"
                                    aria-label="Ù„Ù… ÙŠØªÙ‚Ù† ${skill}" ${disabled}>
                                <span class="not-mastered">Ù„Ù… ÙŠØªÙ‚Ù†</span>
                            </label>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('content').innerHTML = html;
        }

        function updateSkill(subject, skill, status) {
            if (currentUser?.permission === 'read') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª');
                return;
            }
            data[current][subject][skill] = status;
            save();
            updateList();
        }

        function showSkillManagement() {
            const addSkillButton = document.getElementById('addSkillButton');
            addSkillButton.disabled = Object.keys(skills).length === 0;

            let html = `
                <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</h3>
                <div class="skill-management">
                    <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <button class="btn btn-warning" onclick="openModal('subjectModal')" aria-label="Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
                </div>
                <div class="skill-management">
                    <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <button class="btn btn-warning" onclick="openModal('skillModal')" aria-label="Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©" ${Object.keys(skills).length === 0 ? 'disabled' : ''}>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø©</button>
                </div>
                <div class="skill-management">
                    <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙÙˆÙŠØ¶</h4>
                    <input type="text" id="newDelegatedTeacher" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶">
                    <select id="delegationPermission" aria-label="ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù…">
                        <option value="read">Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</option>
                        <option value="edit">ØªØ¹Ø¯ÙŠÙ„</option>
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                    </select>
                    <button class="btn btn-warning" onclick="addDelegatedTeacher()" aria-label="Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ù…ÙÙˆØ¶">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ù…ÙÙˆØ¶</button>
                    <div id="delegatedTeachersList" class="skill-list">
            `;

            Object.entries(delegatedTeachers).forEach(([id, teacher]) => {
                const permissionLabel = teacher.permission === 'read' ? 'Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·' : teacher.permission === 'edit' ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ù…Ø¯ÙŠØ±';
                html += `
                    <div class="delegated-teacher-item">
                        <span>${sanitizeInput(teacher.name)} (${permissionLabel})</span>
                        <button class="btn btn-danger btn-small" onclick="deleteDelegatedTeacher('${id}')" aria-label="Ø­Ø°Ù ${teacher.name}" style="${currentUser?.permission !== 'admin' ? 'display: none;' : ''}">Ø­Ø°Ù</button>
                    </div>
                `;
            });

            html += `</div></div>`;

            if (Object.keys(skills).length === 0) {
                html += `
                    <div class="no-subjects-message">
                        <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</h4>
                        <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
                    </div>
                `;
            } else {
                Object.keys(skills).forEach(subject => {
                    const displayName = sanitizeInput(subjectNames[subject] || subject);
                    html += `
                        <div class="skill-management">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h4>Ù…Ù‡Ø§Ø±Ø§Øª ${displayName}</h4>
                                <button class="btn btn-danger btn-small" onclick="deleteSubject('${subject}')" aria-label="Ø­Ø°Ù ${displayName}" style="${currentUser?.permission !== 'admin' ? 'display: none;' : ''}">Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©</button>
                            </div>
                            <div class="skill-list">
                    `;
                    
                    skills[subject].forEach((skill, index) => {
                        html += `
                            <div class="skill-list-item">
                                <span>${sanitizeInput(skill)}</span>
                                <button class="btn btn-danger btn-small" onclick="deleteSkill('${subject}', ${index})" aria-label="Ø­Ø°Ù ${skill}" style="${currentUser?.permission !== 'admin' ? 'display: none;' : ''}">Ø­Ø°Ù</button>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('content').innerHTML = html;
            updateSkillSubjectDropdown();
            restrictUIByPermission();
        }

        function updateSkillSubjectDropdown() {
            const dropdown = document.getElementById('skillSubject');
            dropdown.innerHTML = '';
            Object.entries(subjectNames).forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = sanitizeInput(name);
                dropdown.appendChild(option);
            });
        }

        function openModal(modalId) {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ø£Ùˆ Ù…Ù‡Ø§Ø±Ø§Øª');
                return;
            }
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById('newSkillName').value = '';
            document.getElementById('newSubjectName').value = '';
        }

        function validateSubjectName(name) {
            const regex = /^[\u0600-\u06FF\s]{2,50}$/;
            return regex.test(name);
        }

        function validateSkillName(name) {
            const regex = /^[\u0600-\u06FF\s]{2,100}$/;
            return regex.test(name);
        }

        function addNewSubject() {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©');
                return;
            }
            const name = sanitizeInput(document.getElementById('newSubjectName').value);
            if (!validateSubjectName(name)) {
                showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø§Ø¯Ø© ØµØ§Ù„Ø­ (2-50 Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠ)');
                return;
            }

            try {
                const id = CryptoJS.SHA256(name + Date.now()).toString();
                if (Object.values(subjectNames).includes(name)) {
                    showError('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }

                skills[id] = [];
                subjectNames[id] = name;
                Object.keys(data).forEach(studentId => {
                    data[studentId][id] = {};
                });

                save();
                closeModal('subjectModal');
                showSkillManagement();
                updateSubjectTabs();
                showSaveMessage();
                console.log(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©: ${name}`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø©: ' + error.message);
            }
        }

        function addNewSkill() {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ø±Ø©');
                return;
            }
            const subject = document.getElementById('skillSubject').value;
            const skillName = sanitizeInput(document.getElementById('newSkillName').value);
            
            if (!subject) {
                showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            if (!validateSkillName(skillName)) {
                showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ù‡Ø§Ø±Ø© ØµØ§Ù„Ø­ (2-100 Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠ)');
                return;
            }

            if (skills[subject].includes(skillName)) {
                showError('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©');
                return;
            }

            try {
                skills[subject].push(skillName);
                Object.keys(data).forEach(studentId => {
                    if (!data[studentId][subject]) {
                        data[studentId][subject] = {};
                    }
                    data[studentId][subject][skillName] = 'not_assessed';
                });

                save();
                closeModal('skillModal');
                showSkillManagement();
                updateSubjectTabs();
                showSaveMessage();
                console.log(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø© "${skillName}" Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø§Ø¯Ø© "${subjectNames[subject]}"`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©: ' + error.message);
            }
        }

        function deleteSubject(subject) {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ§Ø¯');
                return;
            }
            try {
                const displayName = sanitizeInput(subjectNames[subject] || subject);
                if (confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø§Ø¯Ø© "${displayName}"ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
                    delete skills[subject];
                    delete subjectNames[subject];
                    Object.keys(data).forEach(studentId => {
                        delete data[studentId][subject];
                    });
                    save();
                    updateSubjectTabs();
                    if (current && Object.keys(skills).length > 0) {
                        showSubject(Object.keys(skills)[0]);
                    } else {
                        showSkillManagement();
                    }
                    updateList();
                    console.log(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©: ${displayName}`);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©: ' + error.message);
            }
        }

        function deleteSkill(subject, skillIndex) {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª');
                return;
            }
            try {
                const skillName = skills[subject][skillIndex];
                const displayName = sanitizeInput(subjectNames[subject] || subject);
                if (confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ù‡Ø§Ø±Ø© "${sanitizeInput(skillName)}" Ù…Ù† Ù…Ø§Ø¯Ø© "${displayName}"ØŸ\nØ³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
                    skills[subject].splice(skillIndex, 1);
                    if (skills[subject].length === 0) {
                        delete skills[subject];
                        delete subjectNames[subject];
                        Object.keys(data).forEach(studentId => {
                            delete data[studentId][subject];
                        });
                    } else {
                        Object.keys(data).forEach(studentId => {
                            delete data[studentId][subject][skillName];
                        });
                    }
                    save();
                    updateSubjectTabs();
                    if (Object.keys(skills).length === 0) {
                        showSkillManagement();
                    } else if (current && skills[subject]) {
                        showSubject(subject);
                    } else if (current) {
                        showSubject(Object.keys(skills)[0]);
                    } else {
                        showSkillManagement();
                    }
                    updateList();
                    console.log(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø© "${skillName}" Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø© "${displayName}"`);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ø§Ø±Ø©: ' + error.message);
            }
        }

        function addDelegatedTeacher() {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ù…ÙÙˆØ¶');
                return;
            }
            const teacherName = sanitizeInput(document.getElementById('newDelegatedTeacher').value);
            const permission = document.getElementById('delegationPermission').value;
            
            if (!validateTeacherName(teacherName)) {
                showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø¹Ù„Ù… ØµØ§Ù„Ø­ (2-50 Ø­Ø±ÙÙ‹Ø§ Ø¹Ø±Ø¨ÙŠÙ‹Ø§)');
                return;
            }

            if (Object.values(delegatedTeachers).some(t => t.name === teacherName)) {
                showError('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }

            try {
                const teacherId = CryptoJS.SHA256(teacherName + Date.now()).toString();
                delegatedTeachers[teacherId] = { name: teacherName, permission };
                save();
                document.getElementById('newDelegatedTeacher').value = '';
                showSkillManagement();
                showSaveMessage();
                console.log(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶: ${teacherName} Ø¨ØµÙ„Ø§Ø­ÙŠØ© ${permission}`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…: ' + error.message);
            }
        }

        function deleteDelegatedTeacher(teacherId) {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù…Ø¹Ù„Ù… Ù…ÙÙˆØ¶');
                return;
            }
            try {
                const teacherName = delegatedTeachers[teacherId].name;
                if (teacherId === currentUser?.userId) {
                    showError('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù†ÙØ³Ùƒ ÙƒÙ…Ø¹Ù„Ù… Ù…ÙÙˆØ¶');
                    return;
                }
                if (confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶ "${sanitizeInput(teacherName)}"ØŸ`)) {
                    delete delegatedTeachers[teacherId];
                    save();
                    showSkillManagement();
                    console.log(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶: ${teacherName}`);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙÙˆØ¶:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù…: ' + error.message);
            }
        }

        function restrictUIByPermission() {
            const permission = currentUser?.permission || 'admin';
            const deleteButtons = document.querySelectorAll('.btn-danger');
            const editInputs = document.querySelectorAll('input[type="text"], input[type="file"], select, .btn:not(.btn-danger):not(.btn-success):not(.btn-warning)');
            
            if (permission === 'read') {
                editInputs.forEach(input => input.disabled = true);
                deleteButtons.forEach(button => button.style.display = 'none');
                document.querySelectorAll('.btn-warning').forEach(button => button.disabled = true);
                document.getElementById('addSkillButton').disabled = true;
            } else if (permission === 'edit') {
                deleteButtons.forEach(button => button.style.display = 'none');
                document.querySelectorAll('.btn-warning').forEach(button => button.disabled = true);
                document.getElementById('addSkillButton').disabled = true;
            } else {
                editInputs.forEach(input => input.disabled = false);
                deleteButtons.forEach(button => button.style.display = 'inline-block');
                document.querySelectorAll('.btn-warning').forEach(button => button.disabled = false);
                document.getElementById('addSkillButton').disabled = Object.keys(skills).length === 0;
            }
        }

        function exportData() {
            try {
                const exportData = {
                    students: data,
                    skills: skills,
                    subjectNames: subjectNames,
                    delegatedTeachers: delegatedTeachers,
                    lastSaved: new Date().toISOString()
                };
                const dataStr = JSON.stringify(exportData);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `student_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showSaveMessage();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }

        function importData() {
            if (currentUser?.permission !== 'admin') {
                showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }
            document.getElementById('importFile').click();
        }

        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);

                if (!importedData.students || !importedData.skills || !importedData.subjectNames) {
                    throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ÙˆØ£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯');
                }

                if (isValidData(importedData.students) && isValidSkills(importedData.skills) && isValidSubjectNames(importedData.subjectNames)) {
                    data = importedData.students;
                    skills = importedData.skills;
                    subjectNames = importedData.subjectNames;
                    delegatedTeachers = importedData.delegatedTeachers || {};
                    if (!isValidDelegatedTeachers(delegatedTeachers)) {
                        delegatedTeachers = {};
                    }
                    save();
                    updateList();
                    updateSubjectTabs();
                    showSaveMessage();
                    console.log('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            } finally {
                showLoading(false);
                event.target.value = '';
            }
        }

        function showChart() {
            if (!current) {
                showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const labels = [];
            const masteredData = [];
            const notMasteredData = [];

            Object.keys(skills).forEach(subject => {
                const displayName = sanitizeInput(subjectNames[subject] || subject);
                let mastered = 0, notMastered = 0;
                skills[subject].forEach(skill => {
                    const status = data[current][subject][skill];
                    if (status === 'mastered') mastered++;
                    else if (status === 'not_mastered') notMastered++;
                });
                labels.push(displayName);
                masteredData.push(mastered);
                notMasteredData.push(notMastered);
            });

            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.createElement('canvas');
            document.getElementById('content').innerHTML = `<div class="chart-container">${ctx.outerHTML}</div>`;

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø£ØªÙ‚Ù†',
                            data: masteredData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Ù„Ù… ÙŠØªÙ‚Ù†',
                            data: notMasteredData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª' }
                        },
                        x: {
                            title: { display: true, text: 'Ø§Ù„Ù…ÙˆØ§Ø¯' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `ØªÙ‚Ø¯Ù… ${sanitizeInput(data[current].name)}` }
                    }
                }
            });
        }

        function generateReport() {
            if (!current) {
                showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            let html = `<h3>ØªÙ‚Ø±ÙŠØ± ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${sanitizeInput(data[current].name)}</h3>`;
            Object.keys(skills).forEach(subject => {
                const displayName = sanitizeInput(subjectNames[subject] || subject);
                html += `<h4>${displayName}</h4><ul>`;
                skills[subject].forEach(skill => {
                    const status = data[current][subject][skill];
                    const statusText = status === 'mastered' ? 'Ø£ØªÙ‚Ù†' : status === 'not_mastered' ? 'Ù„Ù… ÙŠØªÙ‚Ù†' : 'ØºÙŠØ± Ù…Ù‚ÙŠÙ‘Ù…';
                    const statusClass = status === 'mastered' ? 'mastered' : status === 'not_mastered' ? 'not-mastered' : '';
                    html += `<li><span class="${statusClass}">${sanitizeInput(skill)}: ${statusText}</span></li>`;
                });
                html += '</ul>';
            });

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± ${sanitizeInput(data[current].name)}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h3 { color: #4f46e5; }
                        h4 { color: #7c3aed; margin-top: 20px; }
                        ul { list-style: none; padding: 0; }
                        li { margin: 10px 0; }
                        .mastered { color: #10b981; }
                        .not-mastered { color: #dc2626; }
                    </style>
                </head>
                <body>
                    ${html}
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        function toggleTheme() {
            document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', document.body.dataset.theme);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.dataset.theme = savedTheme;
            load();
        });
    </script>
</body>
</html>
